# 변경 기록 (Changelog)

## 2025년 09월 16일

### 주요 아키텍처 변경

- **프로세스 분리**: 기존의 단일 파일 (`lmfilerecv.py`)에서 웹 서버와 파일 처리 워커가 스레드로 함께 동작하던 구조를 완전히 분리했습니다.
  - **`lmfilerecv.py`**: 이제 순수한 파일 수신 및 저장 역할만 담당하는 경량 웹 서버로 변경되었습니다.
  - **`worker.py`**: 파일 처리 및 OPC-UA 전송을 담당하는 독립된 워커 프로세스를 새로 생성했습니다. 이로 인해 고질적인 스레드 멈춤 현상을 원천적으로 해결하고 시스템 안정성을 크게 향상시켰습니다.
- **실행 모델 변경**: `cron` 기반의 일회성 실행 방식에서, `start.sh`/`shutdown.sh`를 통해 백그라운드에서 계속 실행되는 데몬(daemon) 방식으로 변경하여 관리가 용이해졌습니다.

### 핵심 기능 개선

- **행 단위 변경점 추적**: 파일 전체의 처리 여부를 기록하던 기존 방식에서, 파일과 시트별로 마지막으로 처리한 행의 **시간(timestamp)**을 `last_row_info.json`에 기록하는 방식으로 변경되었습니다. 이를 통해, 이미 처리된 파일에 새로운 데이터가 추가될 경우 **추가된 행만 선별하여 처리**할 수 있게 되었습니다.
- **병렬 처리 (멀티스레딩)**: 워커가 여러 파일을 동시에 처리하도록 `ThreadPoolExecutor`를 도입했습니다. 이로 인해 다수의 파일이 한 번에 유입되어도 병목 현상 없이 빠르게 처리할 수 있습니다.
- **스레드 안전성 확보**: 병렬 처리 시 발생할 수 있는 `last_row_info.json` 파일 접근 충돌(경쟁 상태)을 막기 위해, 파일의 읽기와 쓰기는 메인 루프에서만 일어나도록 데이터 흐름을 재설계하여 처리 기록의 무결성을 보장합니다.
- **소수점 정밀도 제어**: OPC-UA 서버로 소수(float) 값을 전송할 때, 불필요하게 긴 소수점 자리가 붙는 문제를 해결했습니다. 이제 원하는 정밀도(소수점 8자리)로 반올림하고 불필요한 0을 제거한 문자열 형태로 전송하여 깔끔하게 표시됩니다.
- **`TIME` 값 전송 안정화**: 각 데이터 행을 OPC-UA 서버로 전송할 때, `TIME` 컬럼의 값이 항상 가장 마지막에 처리되도록 전송 순서를 보장하여, `TIME` 값이 누락되거나 잘못 기록되는 문제를 해결했습니다.
- **들여쓰기 오류 수정**: 코드 수정 과정에서 발생했던 `IndentationError`를 해결하여 스크립트의 안정적인 실행을 확보했습니다.

### 데이터 파싱 및 오류 처리 강화

- **중복 컬럼 무시**: 엑셀 파일 내에 동일한 이름의 컬럼이 여러 개 있을 경우, 첫 번째 컬럼만 사용하고 나머지는 자동으로 무시하여 잘못된 태그 생성을 방지합니다.
- **`Unnamed` 컬럼 무시**: 의미 없는 `Unnamed:` 이름의 컬럼이 데이터 처리 대상에 포함되지 않도록 자동으로 제외하는 로직을 추가했습니다.
- **OPC-UA 태그 생성 로직 수정**: 엑셀 시트 이름이 존재할 경우, `dataid.시트이름.컬럼명` 형식으로 동적으로 태그(NodeId)를 생성하도록 수정하여, 복잡한 파일 구조에 정확하게 대응하도록 개선했습니다.
- **오류 로깅 강화**: OPC-UA 서버에 태그 쓰기 실패 시, 기존에는 오류를 무시했으나 이제는 어떤 태그에서 어떤 오류가 발생했는지 `[WARNING]` 로그를 남겨 디버깅이 용이해졌습니다.

### 사용성 및 관리 개선

- **프로젝트 구조화**: 파일 처리 로직을 `fileRecv/worker/` 라는 별도 디렉토리로 분리하여 코드의 구조를 명확하게 개선했습니다.
- **관리 스크립트 통합**: 각 프로세스(서버, 워커)를 위한 `start.sh`, `shutdown.sh` 스크립트를 제공하고, 전체 시스템을 한 번에 제어할 수 있는 마스터 스크립트 `start-all.sh`, `shutdown-all.sh`를 최상위 경로에 추가하여 관리를 단순화했습니다.
